<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Lookup</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better readability and spacing */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top to prevent content from being too centered vertically */
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
        }
        .input-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            display: block;
        }
        .input-group input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-group input[type="text"]:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .search-button {
            background-image: linear-gradient(to right, #6366f1, #8b5cf6);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
            border: none;
            cursor: pointer;
        }
        .search-button:hover {
            box-shadow: 0 6px 15px rgba(99, 102, 241, 0.4);
            transform: translateY(-2px);
        }
        .search-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(99, 102, 241, 0.3);
        }
        .results-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 25px;
            border-radius: 10px;
            overflow: hidden; /* Ensures rounded corners on table */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        .results-table th, .results-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .results-table th {
            background-color: #eff6ff;
            color: #1f2937;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        .results-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .results-table tr:hover {
            background-color: #f3f4f6;
        }
        .results-table tr:last-child td {
            border-bottom: none;
        }
        .no-results {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-style: italic;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-box {
            background-color: #fef2f2;
            color: #ef4444;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #fca5a5;
            margin-top: 20px;
            text-align: center;
            font-weight: 500;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-8 text-center">Product Details Lookup</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="input-group">
                <label for="productNameInput">Search by Product Name:</label>
                <input type="text" id="productNameInput" placeholder="e.g., Apple iPhone 15 Pro Max">
            </div>
            <div class="input-group">
                <label for="divisionInput">Search by Division:</label>
                <input type="text" id="divisionInput" placeholder="e.g., Electronics">
            </div>
        </div>

        <div class="flex justify-center mb-8">
            <button id="searchButton" class="search-button flex items-center justify-center">
                <span id="buttonText">Search Products</span>
                <span id="loadingSpinner" class="loading-spinner hidden"></span>
            </button>
        </div>

        <div id="messageBox" class="message-box hidden"></div>

        <div id="resultsContainer">
            <!-- Results will be displayed here -->
            <p class="no-results" id="initialMessage">Enter a product name or division and click 'Search' to see details.</p>
        </div>
    </div>

    <script>
        // The Google Sheet CSV URL.
        // This URL works when the HTML file is served via a local web server (e.g., http://localhost:8000).
        // It will NOT work if you simply double-click the HTML file to open it directly (file:///),
        // due to browser security restrictions (CORS).
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSm2rQ0gZyxlzKOjfZeT2cpq9FNZToHyIinFeEAibJpX5s92iRjzMKFgLnhR82PjmB5PnZqPdbV8K2r/pub?output=csv';

        // Get references to DOM elements
        const productNameInput = document.getElementById('productNameInput');
        const divisionInput = document.getElementById('divisionInput');
        const searchButton = document.getElementById('searchButton');
        const resultsContainer = document.getElementById('resultsContainer');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const buttonText = document.getElementById('buttonText');
        const messageBox = document.getElementById('messageBox');
        const initialMessage = document.getElementById('initialMessage');

        let allProducts = []; // To store the parsed CSV data

        /**
         * Displays a message in the message box.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('error', 'info', 'success').
         */
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-fef2f2', 'text-ef4444', 'border-fca5a5', 'bg-blue-100', 'text-blue-800', 'border-blue-300', 'bg-green-100', 'text-green-800', 'border-green-300');

            if (type === 'error') {
                messageBox.classList.add('bg-fef2f2', 'text-ef4444', 'border-fca5a5');
                console.error("App Message (Error):", message); // Log errors to console
            } else if (type === 'info') {
                messageBox.classList.add('bg-blue-100', 'text-blue-800', 'border-blue-300');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800', 'border-green-300');
            }
            messageBox.classList.remove('hidden');
        }

        /**
         * Hides the message box.
         */
        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        /**
         * Parses CSV text into an array of JavaScript objects.
         * Assumes the first row is the header.
         * @param {string} csvText - The raw CSV string.
         * @returns {Array<Object>} An array of objects, where each object represents a row.
         */
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== ''); // Split by line and remove empty lines
            if (lines.length === 0) return [];

            const headers = lines[0].split(',').map(header => header.trim()); // Get headers
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].trim() : ''; // Assign value to header, handle missing values
                });
                data.push(row);
            }
            return data;
        }

        /**
         * Fetches CSV data from the specified URL.
         * Implements exponential backoff for retries.
         * @param {string} url - The URL of the CSV file.
         * @param {number} retries - Number of retries.
         * @param {number} delay - Initial delay in milliseconds.
         * @returns {Promise<string>} A promise that resolves with the CSV text.
         */
        async function fetchCSVData(url, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    console.log(`Attempt ${i + 1}: Fetching CSV from ${url}`);
                    const response = await fetch(url);
                    if (!response.ok) {
                        // If response is not OK, throw an error to trigger retry or catch block
                        throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                    }
                    const text = await response.text();
                    console.log("CSV data fetched successfully.");
                    return text;
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed to fetch CSV from ${url}:`, error); // Log the full error object
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    } else {
                        // This error message is crucial for local debugging
                        throw new Error(`Failed to fetch CSV data after ${retries} attempts: ${error.message}.
                            If you are running this file directly from your local drive (e.g., file:///),
                            you MUST use a local web server to bypass browser security restrictions (CORS).
                            Please follow the instructions below the code to run a local server.`);
                    }
                }
            }
        }

        /**
         * Renders the search results in a table.
         * @param {Array<Object>} results - The array of product objects to display.
         */
        function renderResults(results) {
            resultsContainer.innerHTML = ''; // Clear previous results
            hideMessage(); // Hide any previous messages

            if (initialMessage) {
                initialMessage.classList.add('hidden'); // Hide initial message once search is performed
            }

            if (results.length === 0) {
                resultsContainer.innerHTML = '<p class="no-results">No products found matching your criteria.</p>';
                return;
            }

            // Create table element
            const table = document.createElement('table');
            table.classList.add('results-table');

            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            // Assuming all objects have the same keys, use the keys from the first object for headers
            const headers = Object.keys(results[0]);
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText.replace(/([A-Z])/g, ' $1').trim(); // Make header more readable (e.g., "productName" -> "Product Name")
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create table body
            const tbody = document.createElement('tbody');
            results.forEach(product => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = product[header];
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            resultsContainer.appendChild(table);
        }

        /**
         * Handles the search button click event.
         * Filters products based on input and displays results.
         */
        async function handleSearch() {
            const productNameQuery = productNameInput.value.toLowerCase().trim();
            const divisionQuery = divisionInput.value.toLowerCase().trim();

            // Validate input: at least one field must have a value
            if (!productNameQuery && !divisionQuery) {
                showMessage('Please enter either a Product Name or a Division to search.', 'info');
                resultsContainer.innerHTML = ''; // Clear results if no input
                if (initialMessage) {
                    initialMessage.classList.remove('hidden'); // Show initial message again
                }
                return;
            }

            // Show loading state
            searchButton.disabled = true;
            loadingSpinner.classList.remove('hidden');
            buttonText.textContent = 'Searching...';
            resultsContainer.innerHTML = ''; // Clear previous results immediately
            hideMessage(); // Hide any existing messages

            // If data hasn't been fetched yet, fetch it
            if (allProducts.length === 0) {
                try {
                    const csvText = await fetchCSVData(CSV_URL);
                    allProducts = parseCSV(csvText);
                    if (allProducts.length === 0) {
                        showMessage('The CSV data is empty or could not be parsed. Please check the sheet content.', 'error');
                        renderResults([]); // Display no results message
                        return;
                    }
                } catch (error) {
                    console.error('Error fetching or parsing CSV:', error);
                    showMessage(`${error.message}`, 'error'); // Display the specific error message from fetchCSVData
                    renderResults([]); // Display no results message
                    return;
                } finally {
                    // Ensure loading state is reset even if an error occurs during fetch
                    searchButton.disabled = false;
                    loadingSpinner.classList.add('hidden');
                    buttonText.textContent = 'Search Products';
                }
            }

            // Filter the products
            const filteredProducts = allProducts.filter(product => {
                const matchesProductName = productNameQuery ?
                    product['Product Name'] && product['Product Name'].toLowerCase().includes(productNameQuery) :
                    true; // If no product name query, consider it a match

                const matchesDivision = divisionQuery ?
                    product['Division'] && product['Division'].toLowerCase().includes(divisionQuery) :
                    true; // If no division query, consider it a match

                // Product must match at least one of the criteria if both are provided,
                // or match the single criterion provided.
                if (productNameQuery && divisionQuery) {
                    // If both are provided, match if it satisfies both conditions
                    return matchesProductName && matchesDivision;
                } else if (productNameQuery) {
                    // Only product name is provided
                    return matchesProductName;
                } else if (divisionQuery) {
                    // Only division is provided
                    return matchesDivision;
                }
                return false; // Should not reach here if input validation works
            });

            // Render the filtered results
            renderResults(filteredProducts);

            // Reset loading state
            searchButton.disabled = false;
            loadingSpinner.classList.add('hidden');
            buttonText.textContent = 'Search Products';
        }

        // Add event listener to the search button
        searchButton.addEventListener('click', handleSearch);

        // Allow pressing Enter in input fields to trigger search
        productNameInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                handleSearch();
            }
        });

        divisionInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                handleSearch();
            }
        });

        // Initial fetch of CSV data when the page loads
        // This pre-loads the data so subsequent searches are faster
        window.onload = async function() {
            try {
                const csvText = await fetchCSVData(CSV_URL);
                allProducts = parseCSV(csvText);
                if (allProducts.length === 0) {
                    showMessage('Failed to load product data or data is empty. Please check the CSV URL and sheet content.', 'error');
                } else {
                    showMessage('Product data loaded successfully! You can now search.', 'success');
                    // Clear the success message after a few seconds
                    setTimeout(hideMessage, 5000);
                }
            } catch (error) {
                console.error('Initial CSV fetch failed:', error);
                showMessage(`${error.message}`, 'error');
            }
        };
    </script>
</body>
</html>
