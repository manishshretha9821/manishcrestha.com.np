<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Batch Lookup Site</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f7f6; text-align: center; padding: 20px; color: #333; }
    .container { max-width: 1300px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    input { padding: 12px; font-size: 16px; width: 300px; border: 2px solid #ddd; border-radius: 6px; outline: none; }
    button { padding: 12px 24px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .table-wrapper { margin-top: 30px; overflow-x: auto; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; display: none; min-width: 1000px; table-layout: fixed; }
    th, td { border: 1px solid #eee; padding: 12px; text-align: left; font-size: 14px; overflow-wrap: break-word; }
    th { background: #007bff; color: white; font-weight: 600; text-transform: uppercase; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    #errorMessage { color: #dc3545; font-weight: bold; margin-top: 15px; }
    .status { font-weight: bold; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
    .expired { background: #ffdce0; color: #af233a; }
    .near { background: #fff3cd; color: #856404; }
    .salable { background: #d4edda; color: #155724; }
  </style>
</head>
<body>

<div class="container">
  <h2>Product Details</h2>
  <input type="text" id="batchInput" placeholder="Batch No, Product, or Division...">
  <button id="searchBtn">Search</button>
  <p id="errorMessage"></p>

  <div class="table-wrapper">
    <table id="resultTable">
      <thead>
        <tr>
          <th>Product Name</th>
          <th>Unit</th>
          <th>Division</th>
          <th>Box/Pkt</th>
          <th>Strip</th>
          <th>Case</th>
          <th>Batch</th>
          <th>MRP</th>
          <th>Sales</th>
          <th>Purchase</th>
          <th>Expiry</th>
          <th>KTM (In)</th>
          <th>KTM (Out)</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="resultBody"></tbody>
    </table>
  </div>
</div>

<script>
let batchData = [];

// Parse CSV from Google Sheet
function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
  if (lines.length === 0) return [];
  const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
  const headers = lines[0].split(regex).map(h => h.replace(/^"|"$/g, '').trim());
  return lines.slice(1).map(line => {
    const values = line.split(regex);
    const entry = {};
    headers.forEach((h, i) => {
      let val = values[i] ? values[i].replace(/^"|"$/g, '').trim() : "N/A";
      entry[h] = val;
    });
    return entry;
  });
}

// Fetch CSV via allorigins proxy
async function fetchCSV() {
  const targetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSMAlrtOL0U2WoM5iDr9DhxpB0s7Khb_oKc2TsBIjkW3gdmG-MoQnuXPwTonum8NNwpOcGntBbwWnpZ/pub?gid=1769485623&single=true&output=csv";
  const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;
  try {
    const response = await fetch(proxyUrl);
    if (!response.ok) throw new Error("Could not connect to the data source.");
    const text = await response.text();
    if (text.includes("<!DOCTYPE html>")) throw new Error("Sheet is not public. Publish it to web.");
    batchData = parseCSV(text);
  } catch (err) {
    document.getElementById("errorMessage").textContent = "Error: " + err.message;
  }
}

// Status based on expiry
function getStatus(expiryStr) {
  if (!expiryStr || expiryStr === "N/A") return { text: "N/A", class: "" };
  const parts = expiryStr.split("/");
  if (parts.length !== 2) return { text: "Invalid Date", class: "" };
  let month = parseInt(parts[0]);
  let year = parseInt(parts[1]);
  if (year < 100) year += 2000;
  const today = new Date();
  const currentMonth = today.getMonth() + 1;
  const currentYear = today.getFullYear();
  const expiryValue = year * 12 + month;
  const currentValue = currentYear * 12 + currentMonth;
  if (expiryValue < currentValue) return { text: "EXPIRED", class: "expired" };
  if (expiryValue <= currentValue + 3) return { text: "NEAR EXPIRY", class: "near" };
  return { text: "SALABLE", class: "salable" };
}

// Format batch with custom rules
function formatBatch(pName, bNumRaw) {
  const batchInt = parseInt(bNumRaw);
  if (isNaN(batchInt)) return bNumRaw;
  pName = pName.toLowerCase();

  if (pName.includes("halozema-s")) {
    return batchInt <= 7010 ? bNumRaw.padStart(5, '0') : bNumRaw.padStart(6, '0');
  }
  if (pName.includes("clotas-s")) {
    return batchInt <= 4012 ? bNumRaw.padStart(5, '0') : bNumRaw.padStart(6, '0');
  }
  return bNumRaw.padStart(6, '0');
}

// Search function
function findBatch() {
  const inputField = document.getElementById("batchInput");
  const rawQuery = inputField.value.trim().toLowerCase();
  const table = document.getElementById("resultTable");
  const tbody = document.getElementById("resultBody");

  document.getElementById("errorMessage").textContent = "";
  tbody.innerHTML = "";

  if (!rawQuery) {
    document.getElementById("errorMessage").textContent = "Please enter a search term.";
    table.style.display = "none";
    return;
  }

  const matches = batchData.filter(entry => {
    const pName = (entry["Product Name"] || "").toLowerCase();
    const dName = (entry["Division"] || "").toLowerCase();
    let bNumRaw = (entry["Batch Number"] || "");
    const bNumFormatted = formatBatch(pName, bNumRaw);

    let numericMatch = false;
    if (/^\d+$/.test(rawQuery)) {
      // Partial numeric match
      const queryFormatted = rawQuery.padStart(6, '0');
      numericMatch = bNumFormatted.includes(queryFormatted);
    }

    return numericMatch || pName.includes(rawQuery) || dName.includes(rawQuery);
  });

  if (matches.length === 0) {
    document.getElementById("errorMessage").textContent = "No matches found.";
    table.style.display = "none";
    return;
  }

  matches.forEach(match => {
    const status = getStatus(match["Expiry"]);
    const pName = (match["Product Name"] || "");
    const displayBatch = formatBatch(pName, (match["Batch Number"] || ""));

    const row = `<tr>
      <td>${pName}</td>
      <td>${match["Unit"] || "N/A"}</td>
      <td>${match["Division"] || "N/A"}</td>
      <td>${match["In 1 box/Packet"] || "N/A"}</td>
      <td>${match["In 1 Blister/Strip"] || "N/A"}</td>
      <td>${match["In 1 case"] || "N/A"}</td>
      <td>${displayBatch}</td>
      <td>${match["MRP"] || "N/A"}</td>
      <td>${match["Sales Rate"] || "N/A"}</td>
      <td>${match["Purchase Rate"] || "N/A"}</td>
      <td>${match["Expiry"] || "N/A"}</td>
      <td>${match["Kathmandu inside"] || "N/A"}</td>
      <td>${match["Kathmandu outside"] || "N/A"}</td>
      <td><span class="status ${status.class}">${status.text}</span></td>
    </tr>`;
    tbody.insertAdjacentHTML('beforeend', row);
  });

  table.style.display = "table";
  inputField.select();
}

// Initialize
window.addEventListener('DOMContentLoaded', () => {
  fetchCSV();
  document.getElementById("searchBtn").addEventListener("click", findBatch);
  document.getElementById("batchInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") findBatch();
  });
});
</script>
</body>
</html>
