<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Nepal Blood Donor Network</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* General Body Styles */
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: #f0f2f5; /* Light gray background for a modern feel */
      margin: 0;
      padding: 0;
      text-align: center;
      color: #333; /* Darker text for readability */
    }

    /* Container for main content */
    .container {
      padding: 30px 20px;
      max-width: 900px;
      margin: 20px auto;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); /* Softer shadow */
    }

    /* Headings */
    h2 {
      color: #c0392b; /* A slightly darker, richer red */
      margin-bottom: 25px;
      font-weight: 700;
      font-size: 1.8em;
    }

    /* Form and Search Container Styling */
    form, .search-container {
      background: #fdfdfd;
      padding: 25px;
      max-width: 500px;
      margin: 25px auto;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05); /* Lighter shadow for sections */
      border: 1px solid #eee; /* Subtle border */
    }

    /* Input and Select Fields */
    input, select {
      width: calc(100% - 22px); /* Account for padding */
      padding: 12px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #ddd; /* Lighter border */
      font-size: 1em;
      box-sizing: border-box; /* Include padding in width */
    }

    input:focus, select:focus {
      border-color: #c0392b; /* Highlight on focus */
      outline: none;
      box-shadow: 0 0 5px rgba(192, 57, 43, 0.3);
    }

    /* Buttons */
    button {
      background-color: #e74c3c; /* Bright red for action */
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 700;
      transition: background-color 0.3s ease; /* Smooth transition */
      margin-top: 10px;
    }

    button:hover {
      background-color: #c0392b; /* Darker red on hover */
    }

    /* Table Styling */
    table {
      width: 95%;
      margin: 30px auto;
      border-collapse: collapse;
      background: #ffffff;
      border-radius: 8px;
      overflow: hidden; /* Ensures rounded corners on table */
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: none; /* Hidden by default */
    }

    th, td {
      padding: 15px;
      border: 1px solid #eee; /* Light border for cells */
      text-align: left;
    }

    th {
      background-color: #e74c3c;
      color: white;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.9em;
    }

    tr:nth-child(even) {
      background-color: #f8f8f8; /* Zebra striping for readability */
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    /* Messages */
    #successMessage {
      color: #27ae60; /* Green for success */
      margin-top: 15px;
      font-weight: bold;
      font-size: 1.05em;
    }

    #errorMessage {
      color: #e74c3c; /* Red for errors */
      font-weight: bold;
      margin-top: 15px;
      font-size: 1.05em;
    }

    /* Motivational Donor Message */
    #donorMessage {
      display: none;
      margin-top: 40px;
      padding: 25px;
      font-size: 1.1em;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      background-color: #ecf0f1; /* Light background for the message box */
      border-left: 5px solid #e74c3c; /* Accent border */
      border-radius: 8px;
      text-align: left;
      line-height: 1.6;
    }

    #donorMessage p {
      margin: 0;
    }

    #donorMessage a {
      color: #e74c3c;
      font-weight: bold;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    #donorMessage a:hover {
      text-decoration: underline;
      color: #c0392b;
    }

    /* Donor Form Container (Initially Hidden) */
    #donorFormContainer {
      display: none;
      margin-top: 20px;
    }

    /* Footer */
    .footer {
      margin-top: 50px;
      padding: 20px;
      background-color: #333;
      color: #bbb;
      font-size: 0.9em;
      border-radius: 0 0 10px 10px; /* Match container border radius */
    }

    .footer a {
      color: #e74c3c;
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

  </style>
</head>
<body>
  <div class="container" id="mainContainer">

    <h2>Find Blood Donors in Nepal</h2>
    <div class="search-container" id="searchSection">
      <label for="bloodGroup" style="display: block; text-align: left; margin-bottom: 5px; font-weight: bold;">Select Blood Group:</label>
      <select id="bloodGroup" onchange="findData()">
        <option value="">-- Select --</option>
        <option value="A+">A+</option>
        <option value="A-">A-</option>
        <option value="B+">B+</option>
        <option value="B-">B-</option>
        <option value="O+">O+</option>
        <option value="O-">O-</option>
        <option value="AB+">AB+</option>
        <option value="AB-">AB-</option>
      </select>
      <p id="errorMessage"></p>
    </div>


    <table id="dataTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Blood Group</th>
          <th>Contact</th>
          <th>Address</th>
        </tr>
      </thead>
      <tbody id="dataBody"></tbody>
    </table>

    <div id="donorMessage">
      <p>
        If this helped you, please consider becoming a part of this life-saving cause!<br>
        You can add your blood group and contact info using the
        <a href="#" onclick="showForm()">link here</a>.<br>
        Then, share this initiative with at least two friends. One simple step could help save a life.
      </p>
    </div>

    <div id="donorFormContainer">
      <h2>Become a Blood Donor</h2>
      <form id="donorForm">
        <input type="text" name="name" placeholder="Your Full Name" required>
        <select name="blood" required>
          <option value="">Select Blood Group</option>
          <option value="A+">A+</option>
          <option value="A-">A-</option>
          <option value="B+">B+</option>
          <option value="B-">B-</option>
          <option value="O+">O+</option>
          <option value="O-">O-</option>
          <option value="AB+">AB+</option>
          <option value="AB-">AB-</option>
        </select>
        <input type="tel" name="contact" placeholder="Contact Number (e.g., 98XXXXXXXX)" required pattern="[0-9]{10}">
        <input type="text" name="address" placeholder="Your City/Area (e.g., Kathmandu, Pokhara)" required>
        <button type="submit">Register as Donor</button>
        <div id="successMessage"></div>
      </form>
    </div>

  </div>

  <div class="footer">
    <p>&copy; 2025 Nepal Blood Donor Network. All rights reserved. | <a href="#">Privacy Policy</a></p>
  </div>

  <script>
    // IMPORTANT: Make sure these URLs are correct and accessible.
    // The scriptURL is for submitting new donor data.
    const scriptURL = "https://corsproxy.io/?https://script.google.com/macros/s/AKfycbw3HWN-1qRC28JZaM-LFAlbOjLL1lnSS_Z8fyH1C6d1oCZxWgidM4n-wxCRDJNjoL0j/exec";
    // The sheetURL is for fetching existing donor data.
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQdyyknQ1kjDCLneXfh_p1zn2Ygj9KXiSOWexKXf-3BcZN8Ae7_5Su3zPEn1lY1gd-gmYVEKXK2ucCP/pub?output=csv";

    // Event listener for the donor registration form submission
    document.getElementById("donorForm").addEventListener("submit", async function(e) {
      e.preventDefault(); // Prevent default form submission
      const form = e.target;
      const formData = new FormData(form);
      const successMessageElem = document.getElementById("successMessage");

      // Convert FormData to a plain object
      const data = {};
      for (let [key, value] of formData.entries()) {
        data[key] = value;
      }

      try {
        const response = await fetch(scriptURL, {
          method: "POST",
          headers: {
            // Set Content-Type to text/plain to bypass complex CORS preflight
            // The Google Apps Script doPost function needs to parse this as JSON
            'Content-Type': 'text/plain;charset=utf-8',
          },
          body: JSON.stringify(data) // Stringify the data as JSON
        });
        const result = await response.text();
        console.log("SERVER RESPONSE:", result);

        if (result.toLowerCase().includes("success")) {
          successMessageElem.innerText = "✅ Thank you for registering! Your data has been added.";
          successMessageElem.style.color = '#27ae60'; // Green for success
          form.reset(); // Clear the form
          await fetchData(); // Refresh data after new submission
          // Optional: Hide the form after success and show search or a confirmation screen
          setTimeout(() => {
              document.getElementById("donorFormContainer").style.display = "none";
              document.getElementById("searchSection").style.display = "block";
          }, 3000); // Hide after 3 seconds
        } else {
          successMessageElem.innerText = "❌ Submission failed. Please try again or contact support.";
          successMessageElem.style.color = '#e74c3c'; // Red for error
        }
      } catch (error) {
        console.error("Submission error:", error);
        successMessageElem.innerText = "❌ Network error. Please check your connection and try again.";
        successMessageElem.style.color = '#e74c3c'; // Red for error
      }
    });

    // Function to show the donor registration form and hide other sections
    function showForm() {
      document.getElementById("searchSection").style.display = "none";
      document.getElementById("dataTable").style.display = "none";
      document.getElementById("donorMessage").style.display = "none";
      document.getElementById("errorMessage").textContent = ""; // Clear any previous error
      document.getElementById("successMessage").textContent = ""; // Clear success message
      document.getElementById("donorFormContainer").style.display = "block";
      document.getElementById("donorForm").reset(); // Reset form when shown
    }

    let allData = []; // Global variable to store all fetched donor data

    // Function to fetch data from Google Sheet
    async function fetchData() {
      const proxy = "https://corsproxy.io/?"; // CORS proxy to bypass cross-origin restrictions
      const url = proxy + sheetURL;
      const errorMessageElem = document.getElementById("errorMessage");

      try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.text();
        processCSV(data);
        errorMessageElem.textContent = ""; // Clear error if data loads
      } catch (error) {
        console.error("Could not load data:", error);
        errorMessageElem.textContent = "Error: Could not load donor data. Please try again later.";
        document.getElementById("dataTable").style.display = "none"; // Hide table on error
      }
    }

    // Function to process CSV data into a usable array of objects
    function processCSV(csvData) {
      const rows = csvData.trim().split("\n").map(row => row.split(","));

      if (rows.length < 2) { // Check if there's at least a header and one data row
        allData = []; // No data available
        return;
      }

      const headers = rows[0].map(header => header.trim()); // Trim headers
      const nameIndex = headers.indexOf("Name");
      const bloodIndex = headers.indexOf("Blood Group");
      const contactIndex = headers.indexOf("Contact");
      const addressIndex = headers.indexOf("Address");

      // Ensure all required headers are found
      if (nameIndex === -1 || bloodIndex === -1 || contactIndex === -1 || addressIndex === -1) {
          document.getElementById("errorMessage").textContent = "Error: Required columns (Name, Blood Group, Contact, Address) not found in sheet.";
          allData = [];
          return;
      }

      allData = rows.slice(1).map(row => ({
        name: row[nameIndex]?.trim() || "N/A",
        blood: row[bloodIndex]?.trim() || "N/A",
        contact: row[contactIndex]?.trim() || "N/A",
        address: row[addressIndex]?.trim() || "N/A"
      }));
    }

    // Function to filter and display donor data based on selected blood group
    function findData() {
      const selectedGroup = document.getElementById("bloodGroup").value;
      const table = document.getElementById("dataTable");
      const tableBody = document.getElementById("dataBody");
      const errorMessageElem = document.getElementById("errorMessage");
      tableBody.innerHTML = ""; // Clear previous results

      document.getElementById("donorMessage").style.display = "none"; // Hide message initially

      if (!selectedGroup) {
        errorMessageElem.textContent = "Please select a blood group to find donors.";
        table.style.display = "none";
        return;
      }

      const filtered = allData.filter(donor => donor.blood === selectedGroup);

      if (filtered.length === 0) {
        errorMessageElem.textContent = `No donors found for blood group '${selectedGroup}' in Nepal at the moment.`;
        table.style.display = "none";
        return;
      }

      errorMessageElem.textContent = ""; // Clear error if results are found
      table.style.display = "table"; // Show the table

      filtered.forEach(d => {
        const row = `<tr>
          <td>${d.name}</td>
          <td>${d.blood}</td>
          <td>${d.contact}</td>
          <td>${d.address}</td>
        </tr>`;
        tableBody.innerHTML += row;
      });

      document.getElementById("donorMessage").style.display = "block"; // Show motivational message after search
    }

    // Initial data fetch when the page loads
    fetchData();
  </script>
</body>
</html>